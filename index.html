<script>
  // Создание карты
  let map = L.map('map', { crs: L.CRS.Simple, minZoom: -4, maxZoom: 5 });

  let mapBounds = [[0, 0], [10000, 15000]];
  map.fitBounds(mapBounds);

  // Загружаем сохранённую позицию, если есть
  const savedCenter = localStorage.getItem('mapCenter');
  const savedZoom = localStorage.getItem('mapZoom');
  if(savedCenter && savedZoom) {
    const center = JSON.parse(savedCenter);
    map.setView(center, parseFloat(savedZoom));
  }

  // Базовый слой
  let fictionCountries = L.imageOverlay('images/fiction_countries.png', mapBounds).addTo(map);

  // Остальные слои
  let realWorld = L.imageOverlay('images/real_world.png', mapBounds, {opacity: 0.5});
  let countryNames = L.imageOverlay('images/country_names.png', mapBounds);
  let cityNames = L.imageOverlay('images/city_names.png', mapBounds);
  let infrastructure = L.imageOverlay('images/infrastructure.png', mapBounds);
  let divisions = L.imageOverlay('images/divisions.png', mapBounds);
  let layer13 = L.imageOverlay('images/layer13.png', mapBounds);
  let foto = L.imageOverlay('images/foto.png', mapBounds);

  let overlays = {
    "Реальний світ": realWorld,
    "Назви країн": countryNames,
    "Назви міст": cityNames,
    "Інфраструктура": infrastructure,
    "Дивізії": divisions,
    "Шар 13": layer13,
    "фото": foto
  };

  map.setMaxBounds(mapBounds);

  // Добавляем кнопки слоёв внизу справа
  const layersPanel = document.getElementById('layers-panel');
  Object.keys(overlays).forEach(name => {
    let btn = document.createElement('button');
    btn.className = 'layer-btn';
    btn.textContent = name;

    btn.addEventListener('click', () => {
      let layer = overlays[name];
      if(map.hasLayer(layer)){
        map.removeLayer(layer);
        btn.classList.remove('active');
      } else {
        map.addLayer(layer);
        btn.classList.add('active');
      }
    });

    layersPanel.appendChild(btn);
  });

  // Переключение темы
  const themeButton = document.getElementById('theme-btn');
  const mapDiv = document.getElementById('map');
  themeButton.addEventListener('click', () => {
    if(mapDiv.classList.contains('light-theme')) {
      mapDiv.classList.replace('light-theme', 'dark-theme');
    } else {
      mapDiv.classList.replace('dark-theme', 'light-theme');
    }
  });

  // Сохраняем позицию карты при движении
  map.on('moveend', () => {
    const center = map.getCenter();
    const zoom = map.getZoom();
    localStorage.setItem('mapCenter', JSON.stringify([center.lat, center.lng]));
    localStorage.setItem('mapZoom', zoom);
  });
</script>
